---
import Layout from "../../layouts/Layout.astro";
import Card from "../../components/Card.astro";
import { supabase } from "../../lib/supabase";

async function fetchPosts() {
  const { data: posts, error: postsError } = await supabase
      .from('posts')
      .select('*')
      .order('id', { ascending: false });

  if (postsError) {
    console.error('Error fetching posts:', postsError);
    return [];
  }

  return await Promise.all(posts.map(async (post) => {
    const { data: author, error: authorError } = await supabase
        .from('profiles')
        .select('username')
        .eq('user_id', post.user_id)
        .single();

    if (authorError) {
      console.error('Error fetching author:', authorError);
      return { ...post, author: { username: 'Unknown' }, image: post.image_url || '' };
    }

    return { ...post, author, image: post.image_url || '' };
  }));
}

type Post = {
  id: string;
  title: string;
  content: string;
  like_count: number;
  dislike_count: number;
  user_id: string;
  author: { username: string };
  image: string;
};

const posts: Post[] = await fetchPosts();
---

<Layout title="ëª¨ë“  ê²Œì‹œë¬¼" description="ëª¨ë“  ê²Œì‹œë¬¼">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-3xl font-bold">ëª¨ë“  ê²Œì‹œë¬¼</h1>
    <a href="/board/new-post" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 focus:outline-none">
      ìƒˆë¡œìš´ ê²Œì‹œë¬¼ ë§Œë“¤ê¸°
    </a>
  </div>
  <ul class="space-y-4">
    {posts.map((post: Post) => (
        <li>
          <Card href={`/board/${post.id}`} title={post.title} body={post.content} image={post.image} />
          <div class="flex space-x-4">
            <span>ì‘ì„±ì: {post.author.username}</span>
            <span>ğŸ‘ {post.like_count}</span>
            <span>ğŸ‘ {post.dislike_count}</span>
          </div>
        </li>
    ))}
  </ul>
</Layout>
